<!DOCTYPE html>
<html lang="en">

<head th:replace="common/head"></head>

<body>

  <div th:replace="common/header"></div>
  <nav th:replace="common/nav"></nav>

  <div class="container mt-5">
    <div class="card">
      <div class="card-body">
        <span class="badge bg-primary rounded-pill" th:text="${qna.id} + '번'"></span>
        <h5 class="card-title" th:text="${qna.title}"></h5>
        <h6 class="card-subtitle mb-2 text-muted" th:text="${qna.userId}"></h6>
        <p class="card-text" th:text="${qna.content}"></p>
        <form action="/qna/comment" method="post">
          <input type="text" name="content">
          <input type="hidden" name="qnaId" th:value="${qna.id}">
          <button type="submit">댓글😊달기</button>
        </form>
        <hr>
        댓글✏️
        <ul th:each="comment : ${qna.comments}">
          <li>
            [[ ${comment.content} ]] / [[ ${comment.writer} ]] / [[${#dates.format(comment.creDate, 'yyyy-MM-dd
            HH:mm:ss')}]]
            <!-- 댓글 삭제 버튼 -->
            <button
              th:if="${session.user_info != null && session.user_info.email == qna.userId || session.user_info.name ==comment.writer }"
              th:onclick="'commentRm(' + ${comment.id} +')'">댓삭🥲</button>
          </li>
        </ul>
        <hr>
        첨부된 파일📥
        <!-- 첨부된 파일 목록 -->
        <ul th:each="fileAtch : ${qna.fileAtchs}">
          <li style="list-style-type: none;">
            <a th:href="@{/download(id=${fileAtch.id})}">
              [[${fileAtch.originalName}]]
            </a>
            <!-- 파일 삭제 버튼 -->
            <button th:if="${session.user_info != null && session.user_info.email == qna.userId && && fileAtch != null}"
              th:onclick="'fileRm(' + ${fileAtch.id} +')'">파일삭제✂️</button>
          </li>
        </ul>

      </div>
    </div>
  </div>
  <div class="container mt-5">
    <ul class="nav justify-content-end">
      <li class="nav-item">
        <a class="nav-link" th:href="@{/qna/list}" id="list">목록</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" th:href="@{'/qna/update/' + ${qna.id}}" id="update">수정</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" th:data-num="${qna.id}" id="delete">삭제</a>
      </li>
    </ul>
  </div>

  <!-- <div th:replace="common/footer">
  </div> -->

  <script>
    var authorUserId = "[[${qna.userId}]]";

    document.querySelector('#update').addEventListener('click', (e) => {
      e.preventDefault();
      // 사용자 정보 가져오기
      var currentUser = "[[${session.user_info != null ? session.user_info.email : ''}]]"; // null 체크 추가
      if (currentUser !== authorUserId) {
        alert('게시글 작성자만 수정할 수 있습니다.'); // 수정 권한이 없을 때 경고창 표시
      } else {
        // 수정 페이지로 이동
        window.location.href = e.target.getAttribute("href");
      }
    });

    document.querySelector('#delete').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('삭제하시겠습니까?')) {
        const num = e.target.dataset.num;
        if (num !== "null")
          location = `/qna/delete/${num}`;
      }
    });

    function commentRm(id) {
      const isOk = confirm('삭제하시겠습니까?');
      if (isOk) {
        location = `/qna/comment/remove?id=${id}&qnaId=[[${qna.id}]]`;
      }
    }

    function fileRm(id) {
      const isOk = confirm('삭제하시겠습니까?');
      if (isOk) {
        location = `/qna/fileAtch/remove?id=${id}&qnaId=[[${qna.id}]]`;
      }
    }
  </script>
</body>

</html>